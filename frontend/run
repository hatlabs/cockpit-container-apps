#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Frontend-specific commands for cockpit-container-apps development.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

################################################################################
# Frontend Development Commands

function build {
  #@ Build frontend for production
  #@ Category: Frontend
  echo "ğŸ“¦ Building frontend..."
  npm run build
  echo "âœ… Frontend build complete"
}

function watch {
  #@ Watch for changes and rebuild
  #@ Category: Frontend
  echo "ğŸ‘€ Watching for changes..."
  npm run watch
}

function test {
  #@ Run frontend tests
  #@ Category: Frontend
  echo "ğŸ§ª Running frontend tests..."
  npm run test
}

function lint {
  #@ Run ESLint and Prettier
  #@ Category: Frontend
  echo "ğŸ” Running linters..."
  npm run lint
}

function lintfix {
  #@ Fix linting issues
  #@ Category: Frontend
  echo "ğŸ”§ Fixing lint issues..."
  npm run lint:fix
}

function typecheck {
  #@ Run TypeScript type checker
  #@ Category: Frontend
  echo "ğŸ“ Running type checker..."
  npm run typecheck
}

function clean {
  #@ Clean frontend build artifacts
  #@ Category: Frontend
  echo "ğŸ§¹ Cleaning frontend build artifacts..."
  rm -rf dist node_modules
  echo "âœ… Frontend cleanup complete"
}

################################################################################
# Help

function help {
  echo "Frontend commands for cockpit-container-apps"
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-25s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Quick start:"
  echo "  1. npm install        # Install dependencies"
  echo "  2. ./run build        # Build frontend"
  echo "  3. ./run watch        # Watch for changes"
}

################################################################################
# Entrypoint

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
